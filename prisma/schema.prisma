// Esquema avanzado de base de datos para WhatsApp Chatbot JARVIS
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Usuario de WhatsApp
model User {
  id            String   @id @default(uuid())
  phoneNumber   String   @unique
  name          String?
  profilePicUrl String?
  language      String   @default("es")
  timezone      String   @default("America/Santiago")
  isBlocked     Boolean  @default(false)
  isVIP         Boolean  @default(false)

  // Metadata
  firstContact  DateTime @default(now())
  lastContact   DateTime @updatedAt
  totalMessages Int      @default(0)

  // Preferencias
  preferences   Json?
  tags          String?  // JSON array de tags

  // Relaciones
  conversations Conversation[]
  messages      Message[]
  analytics     UserAnalytics[]

  @@index([phoneNumber])
  @@index([lastContact])
}

// Conversaci√≥n (sesi√≥n de chat)
model Conversation {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  status      String   @default("active") // active, closed, escalated
  context     Json?    // Contexto de la conversaci√≥n
  sentiment   String?  // positive, neutral, negative
  category    String?  // soporte, ventas, consulta, etc.

  // Control de modo bot/manual
  botMode     String   @default("auto") // auto, manual, hybrid
  assignedTo  String?  // ID del agente humano asignado
  isUnread    Boolean  @default(false) // Para notificaciones en el panel
  tags        String?  // JSON array de tag IDs

  startedAt   DateTime @default(now())
  endedAt     DateTime?

  messages    Message[]

  @@index([userId])
  @@index([status])
  @@index([startedAt])
  @@index([botMode])
  @@index([isUnread])
}

// Mensaje individual
model Message {
  id              String       @id @default(uuid())
  conversationId  String
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  userId          String
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Contenido
  type            String       // text, image, audio, document, video, location, template
  content         String       // Texto o URL del medio
  caption         String?

  // Metadata de WhatsApp
  whatsappId      String?      @unique
  status          String       @default("sent") // sent, delivered, read, failed

  // Direcci√≥n
  direction       String       // inbound, outbound
  sentBy          String?      // "bot", "human", "system"

  // IA y procesamiento
  aiProcessed     Boolean      @default(false)
  aiResponse      String?
  intent          String?      // Intenci√≥n detectada
  entities        Json?        // Entidades extra√≠das

  // Multimedia
  mediaUrl        String?
  mediaMimeType   String?
  mediaSize       Int?

  timestamp       DateTime     @default(now())

  @@index([conversationId])
  @@index([userId])
  @@index([timestamp])
  @@index([whatsappId])
}

// Analytics por usuario
model UserAnalytics {
  id                    String   @id @default(uuid())
  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  date                  DateTime @default(now())

  // M√©tricas
  messagesReceived      Int      @default(0)
  messagesSent          Int      @default(0)
  averageResponseTime   Float?   // en segundos
  conversationDuration  Float?   // en minutos
  satisfactionScore     Float?   // 1-5

  // Engagement
  commandsUsed          Json?    // {comando: count}
  topicsDiscussed       Json?    // {topic: count}

  @@index([userId])
  @@index([date])
}

// Comandos personalizados
model Command {
  id          String   @id @default(uuid())
  trigger     String   @unique  // /comando
  name        String
  description String
  response    String   // Puede ser texto o un template
  isActive    Boolean  @default(true)

  // Analytics
  usageCount  Int      @default(0)
  lastUsed    DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([trigger])
}

// Templates de mensajes
model MessageTemplate {
  id          String   @id @default(uuid())
  name        String   @unique
  category    String   // greeting, farewell, error, help, etc.
  language    String   @default("es")
  content     String
  variables   Json?    // Variables que se pueden reemplazar

  isActive    Boolean  @default(true)
  usageCount  Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([language])
}

// Configuraci√≥n del sistema
model SystemConfig {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  type        String   @default("string") // string, number, boolean, json
  description String?

  updatedAt   DateTime @updatedAt

  @@index([key])
}

// Etiquetas/Tags para organizar usuarios y conversaciones
model Tag {
  id          String   @id @default(uuid())
  name        String   @unique
  color       String   @default("#667eea") // Hex color
  icon        String   @default("üè∑Ô∏è")
  description String?

  // Categor√≠a del tag
  category    String   @default("general") // general, priority, status, custom

  // Control
  isActive    Boolean  @default(true)
  usageCount  Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([name])
  @@index([category])
}

// Webhooks y eventos
model WebhookLog {
  id          String   @id @default(uuid())
  event       String   // message_received, message_sent, status_update
  payload     Json
  status      String   @default("pending") // pending, processed, failed
  error       String?

  processedAt DateTime?
  createdAt   DateTime @default(now())

  @@index([event])
  @@index([status])
  @@index([createdAt])
}

// Campa√±as de broadcast
model Campaign {
  id          String   @id @default(uuid())
  name        String
  message     String
  targetUsers Json     // Criterios de selecci√≥n

  status      String   @default("draft") // draft, scheduled, sending, completed, cancelled

  scheduledFor DateTime?
  sentCount    Int      @default(0)
  deliveredCount Int    @default(0)
  readCount    Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status])
  @@index([scheduledFor])
}

// ==========================================
// SISTEMA DE APRENDIZAJE CONTINUO (RAG)
// ==========================================

// Conversaciones guardadas para aprendizaje
model ConversationLearning {
  id              String   @id @default(cuid())
  conversationId  String?  // Referencia opcional a conversaci√≥n original

  // Contenido de la interacci√≥n
  userMessage     String   // Pregunta/mensaje del usuario
  botResponse     String   // Respuesta del bot

  // Evaluaci√≥n de calidad
  wasHelpful      Boolean? // null = no evaluado, true = √∫til, false = no √∫til
  helpfulScore    Int?     // 1-5 estrellas (opcional)

  // Contexto adicional
  context         Json?    // Informaci√≥n contextual (usuario, tema previo, etc.)
  intent          String?  // Intenci√≥n detectada (saludo, consulta, queja, etc.)
  category        String?  // Categor√≠a del tema (soporte, ventas, info, etc.)

  // Vector embedding reference
  vectorId        String?  // ID en ChromaDB para b√∫squeda sem√°ntica
  embeddingModel  String   @default("nomic-embed-text") // Modelo usado

  // Metadata
  userPhone       String?  // Tel√©fono del usuario (para personalizaci√≥n)
  responseTime    Int?     // Tiempo de respuesta en ms

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([conversationId])
  @@index([wasHelpful])
  @@index([intent])
  @@index([category])
  @@index([createdAt])
  @@index([userPhone])
}

// Registro de feedback de usuarios
model FeedbackLog {
  id              String   @id @default(cuid())
  learningId      String?  // Referencia a ConversationLearning
  conversationId  String?  // Referencia a conversaci√≥n original
  messageId       String?  // Mensaje espec√≠fico evaluado

  // Tipo de feedback
  feedbackType    String   // "thumbs_up", "thumbs_down", "star_rating", "flag", "comment"
  rating          Int?     // 1-5 para star_rating

  // Comentario opcional del usuario
  userComment     String?

  // Metadata
  userPhone       String?
  source          String   @default("whatsapp") // whatsapp, admin_panel, api

  createdAt       DateTime @default(now())

  @@index([learningId])
  @@index([conversationId])
  @@index([feedbackType])
  @@index([createdAt])
}

// Patrones de preguntas frecuentes (auto-generado)
model FrequentPattern {
  id              String   @id @default(cuid())

  // Patr√≥n identificado
  pattern         String   // Ejemplo: "pregunta_hora", "consulta_precio"
  exampleQuery    String   // Ejemplo de pregunta t√≠pica
  bestResponse    String   // Mejor respuesta identificada

  // M√©tricas
  frequency       Int      @default(1)  // Veces que apareci√≥
  successRate     Float?   // % de respuestas √∫tiles
  avgRating       Float?   // Promedio de calificaci√≥n

  // Vector embedding
  vectorId        String?  // ID en ChromaDB

  isActive        Boolean  @default(true)
  lastSeen        DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([pattern])
  @@index([frequency])
  @@index([isActive])
}

// Estad√≠sticas del sistema de aprendizaje
model LearningStats {
  id              String   @id @default(cuid())
  date            DateTime @default(now()) @unique

  // M√©tricas diarias
  totalLearnings  Int      @default(0)  // Conversaciones guardadas
  positiveFeedback Int     @default(0)  // Thumbs up
  negativeFeedback Int     @default(0)  // Thumbs down
  avgResponseTime Float?   // Tiempo promedio de respuesta

  // B√∫squedas sem√°nticas
  totalSearches   Int      @default(0)  // B√∫squedas en ChromaDB
  searchHits      Int      @default(0)  // B√∫squedas con resultados √∫tiles

  // Modelo info
  embeddingsCount Int      @default(0)  // Total de embeddings
  vectorDbSize    Float?   // Tama√±o de ChromaDB en MB

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([date])
}

// ==========================================
// FIN SISTEMA DE APRENDIZAJE
// ==========================================

// Configuraci√≥n del administrador
model AdminProfile {
  id              String   @id @default(uuid())
  username        String   @unique @default("admin")
  password        String   @default("pithy2024")

  // Informaci√≥n personal
  name            String   @default("Administrador")
  email           String   @default("admin@pithy.cl")
  phone           String?
  company         String   @default("PITHY")
  role            String   @default("Administrador")
  avatar          String?  // URL o base64 de la imagen

  // Preferencias
  timezone        String   @default("America/Santiago")
  language        String   @default("es")
  theme           String   @default("dark") // light, dark, system
  accentColor     String   @default("#667eea")

  // Notificaciones
  emailNewMessage      Boolean @default(true)
  emailDailyReport     Boolean @default(false)
  pushNewMessage       Boolean @default(true)
  pushMentions         Boolean @default(true)
  soundEnabled         Boolean @default(true)
  desktopNotifications Boolean @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}